---
title: "Rorcid databasing"
abstract: |
  Case study from the pre-conference workshop "Introduction to R" at the 2020
  Munin Conference on Scholarly Publishing.
  
  https://site.uit.no/muninconf/pre-conference-workshop/
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    toc_depth: 2
---

# Introduction

This page is automatically generated by harvesting information from
[ORCID.org](http://orcid.org).  Starting with a list of maths
researchers with ORCIDs we can curate a list of recent publications.

```{r setup, include = FALSE, cache = FALSE}
library("DT")
library("rorcid")
library("xtable")
library("knitr")
opts_chunk$set(cache=TRUE)
```

This is a bit rough around the edges, but should provide for a useful
case-study.  You will need to install several packages - see file `install.R`.

# Publication metadata analysis with R

## Who do we have in the database?

We start by reading in the database of ORCID identifiers.
You are welcome to use your own CSV file here, for example with ORCIDs
from your own institution. The only mandatory column is `orcid`.

```{r read_data}
maths_csv <- read.csv("maths_orcid.csv", comment.char = '#')
##print(xtable(damtp.csv), type="html")
orcids <- as.character(maths_csv$orcid)
orcids <- orcids[nchar(orcids)>0]  # not everyone has an orcid
print(orcids)
```

We have `r length(orcids)` records in the data base.  (Note that the
number in the previous sentence is not hardcoded in the document, it
is the result of some inline R computation.)

## Interrogate rorcid

Starting with just the ORCIDs, we can get some information such as
names, and DOIs associated with each user.

When you run the following code chunk for the first time, the 
package `rorcid` will open a browser windows so you can log in on
the ORCID website and you can query the ORCID API as an 
authenticated user. You can manually trigger this by calling
`rorcid::orcid_auth()`.

```{r read_records}
get_orcid_info <- function(orcid_num) {
  info <- rorcid::orcid_id(orcid = orcid_num)
  given <- info[[1]]$name$`given-names`$value
  family <- info[[1]]$name$`family-name`$value
  works <- rorcid::works(orcid_num)
  my_dois <- rorcid::identifiers(works)
  num_dois <- length(my_dois)

  list(orcid = orcid_num,
       given = given,
       family = family,
       num_dois = num_dois,
       dois = my_dois)
  
}

results <- lapply(orcids, get_orcid_info)
```

Now we convert these results into a friendly form of a data frame.

```{r data-frame}
given <- sapply(results, function(x) x$given)
family <- sapply(results, function(x) x$family)
orcid <- sapply(results, function(x) x$orcid)
doi_n <- sapply(results, function(x) x$num_dois)

results_df <- data.frame(orcid = orcid, given = given, family = family, doi_n = doi_n)
results_df
```

## Distribution of DOIs associated with each user.

```{r stripchart}
stripchart(results_df$doi_n, method = "jitter", pch = 19, xlab = "number of DOIs")
```

## Interactive table of outputs

We use the function `datatable` from the package `DT` to create a 
paginated searchable table in the HTML output of this document.

```{r interactive_table}
df <-results_df
id1 <- unlist(df$orcid)
url <- sprintf('<a href="http://orcid.org/%s">%s</a>', id1, id1)
df$orcid <- url
DT::datatable(df, escape = 1, options = list(pageLength = 25))
```

## Example listings

Here we automatically generate a "Recent papers" section, by finding
the three most recent papers from each author with an ORCID.

This section is available only if you have the "RefManageR" package
installed.  If you were unable to install it, the following section
will not include any references.

```{r check-RefManageR}
refmanager_available <- require(RefManageR)
```


```{r recent_papers,results="asis",warning=FALSE,eval=refmanager_available}
BibOptions(check.entries = FALSE, style = "markdown", bib.style = "authoryear", cite.style = 'alphabetic', max.names=7)

dois = c() # the vector of dois
for (i in 1:nrow(df)) {
  doi_n = df[i,"doi_n"]
  if ( doi_n > 0 ) { # check if entry has a DOI
    dois = c(dois, results[[i]]$dois[1:(min(2, doi_n))])
  }
}
##dois = grab.info[[4]]$dois[1:3]
bibentries <- RefManageR::GetBibEntryWithDOI(dois)
print(bibentries)
```

# Discussion

We make heavy use of knitr; see
e.g. <https://yihui.org/knitr/options/> for chunk options.  Things to
discuss:

- The cache facility is awesome.
- How to extend?
  - Use your own database of ORCIDs?
  - Scrape ORCIDs from Munin website?

# Compiling this document

Because we rely on interactive authentication with ORCID, the "Knit" button
in RStudio will not work, because every time you knit an R Markdown
document, RStudio will start a clean empty R session.  See 
`?rorcid::orcid_auth` on how to store the authentication information 
outside of the R session.

```{r compiling, include = TRUE, eval = FALSE}
rmarkdown::render("orcid3.Rmd")
```

# Colophon

It is good practice to [capture the used the environment](https://twitter.com/benmarwick/status/1263291191606444033)
at the bottom  of a document.

This report was generated on `r Sys.time()` using the following 
computational environment and dependencies: 

```{r colophon, cache = FALSE}
# Based on https://github.com/benmarwick/rrtools/blob/master/inst/templates/paper.Rmd
if ("devtools" %in% installed.packages()) {
  devtools::session_info() # includes installation source of packages
} else {
  sessionInfo()
}
```

